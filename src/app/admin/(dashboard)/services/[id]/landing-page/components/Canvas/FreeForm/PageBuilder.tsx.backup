// PageBuilder.tsx
// Enterprise-grade page builder with nested stack support + LocalStorage Save/Load

import React, { useState, useEffect, useCallback } from 'react';
import { Section, Container, Stack, Grid } from './primitives.index';
import { ContentHeading, ContentText, ContentButton, ContentImage } from './content.index';
import { SelectableBlockWrapper } from './SelectableBlockWrapper';
import { PrimitivePropertiesPanel } from './PrimitivePropertiesPanel';
import { ComponentLibrary } from './ComponentLibrary';
import type { SectionConfig, ContainerConfig, StackConfig, GridConfig } from './primitives.types';
import type { HeadingConfig, TextConfig, ButtonConfig, ImageConfig, ContentComponent } from './content.types';

// ============================================================================
// TYPE DEFINITIONS
// ============================================================================

interface PageSection {
  section: SectionConfig;
  container: ContainerConfig;
  stacks: StackConfig[];
  grids: GridConfig[];
}

type ElementType = 'section' | 'container' | 'stack' | 'grid' | 'content';
type LibraryContext = 'section' | 'stack' | 'grid' | 'content';

// ============================================================================
// LOCALSTORAGE KEYS
// ============================================================================

const STORAGE_KEY = 'landing-page-builder-sections';
const LAST_SAVED_KEY = 'landing-page-builder-last-saved';
const AUTO_SAVE_INTERVAL = 30000; // 30 seconds

// ============================================================================
// DEFAULT TEMPLATE
// ============================================================================

const getDefaultTemplate = (): PageSection[] => [
  {
    section: {
      id: 'hero-section',
      type: 'section',
      width: '100%',
      paddingTop: 120,
      paddingBottom: 120,
      background: {
        type: 'gradient',
        gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
      },
      children: [],
    },
    container: {
      id: 'hero-container',
      type: 'container',
      variant: 'standard',
      maxWidth: 1200,
      paddingX: 24,
      margin: 'auto',
      children: [],
    },
    stacks: [
      {
        id: 'hero-main-stack',
        type: 'stack',
        direction: 'horizontal',
        gap: 64,
        align: 'center',
        justify: 'space-between',
        width: 'fill',
        children: [
          {
            id: 'hero-left-stack',
            type: 'stack',
            direction: 'vertical',
            gap: 24,
            align: 'start',
            justify: 'center',
            maxWidth: 600,
            children: [
              {
                id: 'hero-badge',
                type: 'text',
                text: '‚ú® Yeni A√ßƒ±ldƒ±k - ƒ∞lk 50 M√º≈üteriye %20 ƒ∞ndirim',
                fontSize: 14,
                fontWeight: 600,
                color: '#ffffff',
                textAlign: 'left',
                marginBottom: 0,
              } as TextConfig,
              {
                id: 'hero-title',
                type: 'heading',
                text: 'Premium Headspa Deneyimi',
                level: 'h1',
                fontSize: 56,
                fontWeight: 700,
                color: '#ffffff',
                textAlign: 'left',
                lineHeight: 1.2,
              } as HeadingConfig,
              {
                id: 'hero-subtitle',
                type: 'text',
                text: 'Stresinizi atƒ±n, zihninizi dinlendirin. Profesyonel terapistlerimizle l√ºks wellness tedavisi.',
                fontSize: 20,
                fontWeight: 400,
                color: 'rgba(255, 255, 255, 0.9)',
                textAlign: 'left',
                lineHeight: 1.6,
              } as TextConfig,
              {
                id: 'hero-buttons-stack',
                type: 'stack',
                direction: 'horizontal',
                gap: 16,
                align: 'center',
                justify: 'start',
                children: [
                  {
                    id: 'hero-cta-button',
                    type: 'button',
                    text: 'Hemen Randevu Al',
                    variant: 'primary',
                    size: 'lg',
                    backgroundColor: '#ffffff',
                    textColor: '#764ba2',
                    fontSize: 18,
                    fontWeight: 600,
                    paddingX: 32,
                    paddingY: 16,
                    borderRadius: 8,
                    href: '#booking',
                  } as ButtonConfig,
                  {
                    id: 'hero-secondary-button',
                    type: 'button',
                    text: 'Hizmetleri ƒ∞ncele',
                    variant: 'outline',
                    size: 'lg',
                    backgroundColor: 'transparent',
                    textColor: '#ffffff',
                    borderColor: '#ffffff',
                    fontSize: 18,
                    fontWeight: 600,
                    paddingX: 32,
                    paddingY: 16,
                    borderRadius: 8,
                    href: '#services',
                  } as ButtonConfig,
                ],
              },
            ],
          },
          {
            id: 'hero-image',
            type: 'image',
            src: '/images/headspa-hero.jpg',
            alt: 'Premium Headspa Treatment',
            width: 500,
            height: 500,
            objectFit: 'cover',
            borderRadius: 16,
          } as ImageConfig,
        ],
      },
    ],
    grids: [],
  },
  {
    section: {
      id: 'features-section',
      type: 'section',
      width: '100%',
      paddingTop: 80,
      paddingBottom: 80,
      background: {
        type: 'color',
        color: '#f9fafb',
      },
      children: [],
    },
    container: {
      id: 'features-container',
      type: 'container',
      variant: 'standard',
      maxWidth: 1200,
      paddingX: 24,
      margin: 'auto',
      children: [],
    },
    stacks: [
      {
        id: 'features-header-stack',
        type: 'stack',
        direction: 'vertical',
        gap: 16,
        align: 'center',
        justify: 'center',
        width: 'fill',
        children: [
          {
            id: 'features-title',
            type: 'heading',
            text: 'Neden Bizi Se√ßmelisiniz?',
            level: 'h2',
            fontSize: 42,
            fontWeight: 700,
            color: '#1f2937',
            textAlign: 'center',
            marginBottom: 8,
          } as HeadingConfig,
          {
            id: 'features-subtitle',
            type: 'text',
            text: 'Size √∂zel wellness deneyimi i√ßin profesyonel ekibimiz ve premium hizmetlerimiz',
            fontSize: 18,
            fontWeight: 400,
            color: '#6b7280',
            textAlign: 'center',
            maxWidth: 700,
            marginBottom: 48,
          } as TextConfig,
        ],
      },
    ],
    grids: [
      {
        id: 'features-grid',
        type: 'grid',
        columns: 3,
        gap: 32,
        align: 'start',
        padding: 0,
        children: [
          {
            id: 'feature-card-1',
            type: 'text',
            text: 'üßò‚Äç‚ôÄÔ∏è',
            fontSize: 48,
            fontWeight: 400,
            color: '#764ba2',
            textAlign: 'center',
            marginBottom: 16,
          } as TextConfig,
          {
            id: 'feature-1-title',
            type: 'heading',
            text: 'Profesyonel Ekip',
            level: 'h3',
            fontSize: 24,
            fontWeight: 600,
            color: '#1f2937',
            textAlign: 'center',
            marginBottom: 8,
          } as HeadingConfig,
          {
            id: 'feature-1-desc',
            type: 'text',
            text: 'Sertifikalƒ± terapistlerimiz, yƒ±llarca deneyimle size hizmet ediyor',
            fontSize: 16,
            fontWeight: 400,
            color: '#6b7280',
            textAlign: 'center',
          } as TextConfig,
          {
            id: 'feature-card-2',
            type: 'text',
            text: '‚ú®',
            fontSize: 48,
            fontWeight: 400,
            color: '#764ba2',
            textAlign: 'center',
            marginBottom: 16,
          } as TextConfig,
          {
            id: 'feature-2-title',
            type: 'heading',
            text: 'Premium √úr√ºnler',
            level: 'h3',
            fontSize: 24,
            fontWeight: 600,
            color: '#1f2937',
            textAlign: 'center',
            marginBottom: 8,
          } as HeadingConfig,
          {
            id: 'feature-2-desc',
            type: 'text',
            text: 'Doƒüal ve organik malzemeler kullanarak cildinize √∂zen g√∂steriyoruz',
            fontSize: 16,
            fontWeight: 400,
            color: '#6b7280',
            textAlign: 'center',
          } as TextConfig,
          {
            id: 'feature-card-3',
            type: 'text',
            text: 'üéØ',
            fontSize: 48,
            fontWeight: 400,
            color: '#764ba2',
            textAlign: 'center',
            marginBottom: 16,
          } as TextConfig,
          {
            id: 'feature-3-title',
            type: 'heading',
            text: 'Ki≈üiselle≈ütirilmi≈ü',
            level: 'h3',
            fontSize: 24,
            fontWeight: 600,
            color: '#1f2937',
            textAlign: 'center',
            marginBottom: 8,
          } as HeadingConfig,
          {
            id: 'feature-3-desc',
            type: 'text',
            text: 'ƒ∞htiya√ßlarƒ±nƒ±za √∂zel tedavi planƒ± ile maksimum rahatlama',
            fontSize: 16,
            fontWeight: 400,
            color: '#6b7280',
            textAlign: 'center',
          } as TextConfig,
        ],
      },
    ],
  },
  {
    section: {
      id: 'services-section',
      type: 'section',
      width: '100%',
      paddingTop: 80,
      paddingBottom: 80,
      background: {
        type: 'color',
        color: '#ffffff',
      },
      children: [],
    },
    container: {
      id: 'services-container',
      type: 'container',
      variant: 'standard',
      maxWidth: 1200,
      paddingX: 24,
      margin: 'auto',
      children: [],
    },
    stacks: [
      {
        id: 'services-header',
        type: 'stack',
        direction: 'vertical',
        gap: 16,
        align: 'center',
        children: [
          {
            id: 'services-title',
            type: 'heading',
            text: 'Pop√ºler Hizmetlerimiz',
            level: 'h2',
            fontSize: 42,
            fontWeight: 700,
            color: '#1f2937',
            textAlign: 'center',
            marginBottom: 48,
          } as HeadingConfig,
        ],
      },
      {
        id: 'services-cards-stack',
        type: 'stack',
        direction: 'horizontal',
        gap: 32,
        align: 'stretch',
        justify: 'space-between',
        children: [
          {
            id: 'service-card-1',
            type: 'stack',
            direction: 'vertical',
            gap: 16,
            align: 'start',
            padding: 32,
            background: {
              type: 'color',
              color: '#f9fafb',
            },
            border: {
              enabled: true,
              width: 1,
              style: 'solid',
              color: '#e5e7eb',
              radius: 12,
            },
            children: [
              {
                id: 'service-1-title',
                type: 'heading',
                text: 'Classic Headspa',
                level: 'h3',
                fontSize: 28,
                fontWeight: 600,
                color: '#1f2937',
                textAlign: 'left',
              } as HeadingConfig,
              {
                id: 'service-1-desc',
                type: 'text',
                text: 'Rahatlatƒ±cƒ± kafa masajƒ± ve aromaterapi ile stres atma seansƒ±. G√ºnl√ºk yorgunluƒüu atƒ±n.',
                fontSize: 16,
                fontWeight: 400,
                color: '#6b7280',
                textAlign: 'left',
                lineHeight: 1.6,
              } as TextConfig,
              {
                id: 'service-1-features',
                type: 'text',
                text: '‚Ä¢ Kafa masajƒ±\n‚Ä¢ Aromaterapi\n‚Ä¢ Rahatlama m√ºziƒüi',
                fontSize: 14,
                fontWeight: 400,
                color: '#9ca3af',
                textAlign: 'left',
                lineHeight: 1.8,
              } as TextConfig,
              {
                id: 'service-1-price',
                type: 'text',
                text: '‚Ç∫85',
                fontSize: 32,
                fontWeight: 700,
                color: '#764ba2',
                textAlign: 'left',
                marginTop: 16,
              } as TextConfig,
              {
                id: 'service-1-duration',
                type: 'text',
                text: '60 dakika',
                fontSize: 14,
                fontWeight: 400,
                color: '#6b7280',
                textAlign: 'left',
              } as TextConfig,
              {
                id: 'service-1-button',
                type: 'button',
                text: 'Randevu Al',
                variant: 'primary',
                size: 'md',
                backgroundColor: '#764ba2',
                textColor: '#ffffff',
                fontSize: 16,
                fontWeight: 600,
                paddingX: 24,
                paddingY: 12,
                borderRadius: 8,
              } as ButtonConfig,
            ],
          },
          {
            id: 'service-card-2',
            type: 'stack',
            direction: 'vertical',
            gap: 16,
            align: 'start',
            padding: 32,
            background: {
              type: 'gradient',
              gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            },
            border: {
              enabled: false,
              width: 0,
              style: 'solid',
              color: '#000000',
              radius: 12,
            },
            shadow: {
              enabled: true,
              offsetX: 0,
              offsetY: 8,
              blur: 24,
              spread: 0,
              color: 'rgba(118, 75, 162, 0.3)',
            },
            children: [
              {
                id: 'service-2-badge',
                type: 'text',
                text: '‚≠ê EN POP√úLER',
                fontSize: 12,
                fontWeight: 700,
                color: '#ffffff',
                textAlign: 'left',
                marginBottom: 8,
              } as TextConfig,
              {
                id: 'service-2-title',
                type: 'heading',
                text: 'Premium Headspa',
                level: 'h3',
                fontSize: 28,
                fontWeight: 600,
                color: '#ffffff',
                textAlign: 'left',
              } as HeadingConfig,
              {
                id: 'service-2-desc',
                type: 'text',
                text: 'L√ºks wellness deneyimi: Headspa + Y√ºz masajƒ± + Aromaterapi. Kendinize deƒüer verin.',
                fontSize: 16,
                fontWeight: 400,
                color: 'rgba(255,255,255,0.9)',
                textAlign: 'left',
                lineHeight: 1.6,
              } as TextConfig,
              {
                id: 'service-2-features',
                type: 'text',
                text: '‚Ä¢ Premium kafa masajƒ±\n‚Ä¢ Y√ºz masajƒ±\n‚Ä¢ Aromaterapi\n‚Ä¢ Sƒ±cak havlu uygulamasƒ±',
                fontSize: 14,
                fontWeight: 400,
                color: 'rgba(255,255,255,0.8)',
                textAlign: 'left',
                lineHeight: 1.8,
              } as TextConfig,
              {
                id: 'service-2-price',
                type: 'text',
                text: '‚Ç∫150',
                fontSize: 32,
                fontWeight: 700,
                color: '#ffffff',
                textAlign: 'left',
                marginTop: 16,
              } as TextConfig,
              {
                id: 'service-2-duration',
                type: 'text',
                text: '90 dakika',
                fontSize: 14,
                fontWeight: 400,
                color: 'rgba(255,255,255,0.8)',
                textAlign: 'left',
              } as TextConfig,
              {
                id: 'service-2-button',
                type: 'button',
                text: 'Hemen Rezerve Et',
                variant: 'primary',
                size: 'md',
                backgroundColor: '#ffffff',
                textColor: '#764ba2',
                fontSize: 16,
                fontWeight: 600,
                paddingX: 24,
                paddingY: 12,
                borderRadius: 8,
              } as ButtonConfig,
            ],
          },
        ],
      },
    ],
    grids: [],
  },
  {
    section: {
      id: 'cta-section',
      type: 'section',
      width: '100%',
      paddingTop: 80,
      paddingBottom: 80,
      background: {
        type: 'color',
        color: '#1f2937',
      },
      children: [],
    },
    container: {
      id: 'cta-container',
      type: 'container',
      variant: 'narrow',
      maxWidth: 940,
      paddingX: 24,
      margin: 'auto',
      children: [],
    },
    stacks: [
      {
        id: 'cta-stack',
        type: 'stack',
        direction: 'vertical',
        gap: 24,
        align: 'center',
        justify: 'center',
        children: [
          {
            id: 'cta-title',
            type: 'heading',
            text: 'Hazƒ±r mƒ±sƒ±nƒ±z?',
            level: 'h2',
            fontSize: 42,
            fontWeight: 700,
            color: '#ffffff',
            textAlign: 'center',
          } as HeadingConfig,
          {
            id: 'cta-text',
            type: 'text',
            text: 'ƒ∞lk randevunuzu bug√ºn alƒ±n ve kendinize √∂zel wellness deneyimini ya≈üayƒ±n',
            fontSize: 18,
            fontWeight: 400,
            color: 'rgba(255,255,255,0.8)',
            textAlign: 'center',
            maxWidth: 600,
            lineHeight: 1.6,
          } as TextConfig,
          {
            id: 'cta-button',
            type: 'button',
            text: '≈ûimdi Randevu Al',
            variant: 'primary',
            size: 'lg',
            backgroundColor: '#764ba2',
            textColor: '#ffffff',
            fontSize: 20,
            fontWeight: 600,
            paddingX: 40,
            paddingY: 16,
            borderRadius: 8,
          } as ButtonConfig,
        ],
      },
    ],
    grids: [],
  },
];

// ============================================================================
// MAIN COMPONENT
// ============================================================================

export function PageBuilder() {
  const [selectedId, setSelectedId] = useState<string | null>(null);
  const [isLibraryOpen, setIsLibraryOpen] = useState(false);
  const [libraryContext, setLibraryContext] = useState<LibraryContext>('section');
  const [sections, setSections] = useState<PageSection[]>([]);
  const [lastSaved, setLastSaved] = useState<Date | null>(null);
  const [isSaving, setIsSaving] = useState(false);
  const [saveStatus, setSaveStatus] = useState<'saved' | 'saving' | 'unsaved'>('saved');

  // ============================================================================
  // SAVE/LOAD FUNCTIONS
  // ============================================================================

  const loadFromLocalStorage = useCallback(() => {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      const lastSavedStr = localStorage.getItem(LAST_SAVED_KEY);

      if (stored) {
        const parsed = JSON.parse(stored);
        setSections(parsed);
        console.log('‚úÖ Loaded from localStorage:', parsed.length, 'sections');
      } else {
        // No saved data, load default template
        const defaultSections = getDefaultTemplate();
        setSections(defaultSections);
        console.log('üìÑ Loaded default template');
      }

      if (lastSavedStr) {
        setLastSaved(new Date(lastSavedStr));
      }
    } catch (error) {
      console.error('‚ùå Error loading from localStorage:', error);
      // Fallback to default template
      setSections(getDefaultTemplate());
    }
  }, []);

  const saveToLocalStorage = useCallback((sectionsToSave: PageSection[]) => {
    try {
      setIsSaving(true);
      setSaveStatus('saving');

      const serialized = JSON.stringify(sectionsToSave);
      localStorage.setItem(STORAGE_KEY, serialized);

      const now = new Date();
      localStorage.setItem(LAST_SAVED_KEY, now.toISOString());
      setLastSaved(now);

      setSaveStatus('saved');
      console.log('üíæ Saved to localStorage:', sectionsToSave.length, 'sections');

      // Show saved indicator for 2 seconds
      setTimeout(() => {
        setIsSaving(false);
      }, 2000);
    } catch (error) {
      console.error('‚ùå Error saving to localStorage:', error);
      setSaveStatus('unsaved');
      setIsSaving(false);
    }
  }, []);

  const handleManualSave = useCallback(() => {
    saveToLocalStorage(sections);
  }, [sections, saveToLocalStorage]);

  const handleExport = useCallback(() => {
    try {
      const dataStr = JSON.stringify(sections, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `landing-page-${Date.now()}.json`;
      link.click();
      URL.revokeObjectURL(url);
      console.log('üì• Exported landing page data');
    } catch (error) {
      console.error('‚ùå Error exporting:', error);
    }
  }, [sections]);

  const handleImport = useCallback((event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const content = e.target?.result as string;
        const imported = JSON.parse(content);
        setSections(imported);
        saveToLocalStorage(imported);
        console.log('üì§ Imported landing page data');
      } catch (error) {
        console.error('‚ùå Error importing:', error);
        alert('Invalid file format');
      }
    };
    reader.readAsText(file);
  }, [saveToLocalStorage]);

  // ============================================================================
  // EFFECTS
  // ============================================================================

  // Load on mount
  useEffect(() => {
    loadFromLocalStorage();
  }, [loadFromLocalStorage]);

  // Auto-save every 30 seconds
  useEffect(() => {
    const interval = setInterval(() => {
      if (sections.length > 0) {
        saveToLocalStorage(sections);
      }
    }, AUTO_SAVE_INTERVAL);

    return () => clearInterval(interval);
  }, [sections, saveToLocalStorage]);

  // Mark as unsaved when sections change
  useEffect(() => {
    if (sections.length > 0 && saveStatus === 'saved') {
      setSaveStatus('unsaved');
    }
  }, [sections]);

  // ============================================================================
  // HELPER FUNCTIONS - Element Discovery
  // ============================================================================

  const findElementById = (
    id: string,
    elements: (StackConfig | ContentComponent)[]
  ): StackConfig | ContentComponent | null => {
    for (const element of elements) {
      if (element.id === id) return element;
      
      if (element.type === 'stack' && 'children' in element) {
        const found = findElementById(id, element.children);
        if (found) return found;
      }
    }
    return null;
  };

  const getSelectedElementType = (): ElementType | null => {
    if (!selectedId) return null;

    for (const pageSection of sections) {
      if (pageSection.section.id === selectedId) return 'section';
      if (pageSection.container.id === selectedId) return 'container';

      const stackElement = findElementById(selectedId, pageSection.stacks);
      if (stackElement) {
        return stackElement.type === 'stack' ? 'stack' : 'content';
      }

      for (const grid of pageSection.grids) {
        if (grid.id === selectedId) return 'grid';
        const gridContent = findElementById(selectedId, grid.children);
        if (gridContent) return 'content';
      }
    }
    return null;
  };

  const getSelectedElement = (): SectionConfig | ContainerConfig | StackConfig | GridConfig | ContentComponent | null => {
    if (!selectedId) return null;

    for (const pageSection of sections) {
      if (pageSection.section.id === selectedId) return pageSection.section;
      if (pageSection.container.id === selectedId) return pageSection.container;

      const stackElement = findElementById(selectedId, pageSection.stacks);
      if (stackElement) return stackElement;

      for (const grid of pageSection.grids) {
        if (grid.id === selectedId) return grid;
        const gridContent = findElementById(selectedId, grid.children);
        if (gridContent) return gridContent;
      }
    }
    return null;
  };

  // ============================================================================
  // CRUD OPERATIONS - Add
  // ============================================================================

  const handleSmartAdd = () => {
    const selectedType = getSelectedElementType();

    if (!selectedType) {
      setLibraryContext('section');
      setIsLibraryOpen(true);
      return;
    }

    if (selectedType === 'section' || selectedType === 'container') {
      setLibraryContext('stack');
      setIsLibraryOpen(true);
      return;
    }

    if (selectedType === 'stack' || selectedType === 'grid' || selectedType === 'content') {
      setLibraryContext('content');
      setIsLibraryOpen(true);
      return;
    }
  };

  const handleAddSection = (newSection: SectionConfig) => {
    const newPageSection: PageSection = {
      section: newSection,
      container: {
        id: `container-${Date.now()}`,
        type: 'container',
        variant: 'standard',
        maxWidth: 1200,
        paddingX: 24,
        margin: 'auto',
        children: [],
      },
      stacks: [
        {
          id: `stack-${Date.now()}`,
          type: 'stack',
          direction: 'vertical',
          gap: 24,
          align: 'center',
          justify: 'center',
          width: 'fill',
          children: [
            {
              id: `heading-${Date.now()}`,
              type: 'heading' as const,
              text: 'New Section Heading',
              level: 'h2' as const,
              fontSize: 36,
              fontWeight: 700,
              color: '#1f2937',
              textAlign: 'center' as const,
            } as HeadingConfig,
            {
              id: `text-${Date.now()}`,
              type: 'text' as const,
              text: 'Click to edit this text or add more content below.',
              fontSize: 16,
              fontWeight: 400,
              color: '#6b7280',
              textAlign: 'center' as const,
            } as TextConfig,
          ],
        },
      ],
      grids: [],
    };
    setSections([...sections, newPageSection]);
    setIsLibraryOpen(false);
  };

  const handleAddStack = (newStack: StackConfig) => {
    if (!selectedId) {
      alert('Please select a Section or Container first');
      return;
    }

    const stackWithContent: StackConfig = {
      ...newStack,
      children: [
        {
          id: `text-${Date.now()}`,
          type: 'text' as const,
          text: 'New stack - add content here',
          fontSize: 16,
          fontWeight: 400,
          color: '#9ca3af',
          textAlign: 'center' as const,
        } as TextConfig,
      ],
    };

    const updatedSections = sections.map((pageSection) => {
      if (pageSection.section.id === selectedId || pageSection.container.id === selectedId) {
        return {
          ...pageSection,
          stacks: [...pageSection.stacks, stackWithContent],
        };
      }

      const addNestedStack = (elements: (StackConfig | ContentComponent)[]): (StackConfig | ContentComponent)[] => {
        return elements.map((element) => {
          if (element.type === 'stack' && element.id === selectedId) {
            return {
              ...element,
              children: [...element.children, stackWithContent],
            };
          }
          if (element.type === 'stack' && 'children' in element) {
            return {
              ...element,
              children: addNestedStack(element.children),
            };
          }
          return element;
        });
      };

      return {
        ...pageSection,
        stacks: addNestedStack(pageSection.stacks) as StackConfig[],
      };
    });

    setSections(updatedSections);
    setIsLibraryOpen(false);
  };

  const handleAddGrid = (newGrid: GridConfig) => {
    if (!selectedId) {
      alert('Please select a Section or Container first');
      return;
    }

    const placeholderItems = Array.from({ length: newGrid.columns }, (_, i) => ({
      id: `text-${Date.now()}-${i}`,
      type: 'text' as const,
      text: `Grid Item ${i + 1}`,
      fontSize: 16,
      fontWeight: 400,
      color: '#9ca3af',
      textAlign: 'center' as const,
    } as TextConfig));

    const gridWithContent: GridConfig = {
      ...newGrid,
      children: placeholderItems,
    };

    const updatedSections = sections.map((pageSection) => {
      if (pageSection.section.id === selectedId || pageSection.container.id === selectedId) {
        return {
          ...pageSection,
          grids: [...pageSection.grids, gridWithContent],
        };
      }
      return pageSection;
    });

    setSections(updatedSections);
    setIsLibraryOpen(false);
  };

  const handleAddContent = (newContent: ContentComponent) => {
    if (!selectedId) {
      alert('Please select a Stack or Grid first');
      return;
    }

    const updatedSections = sections.map((pageSection) => {
      const addToStack = (elements: (StackConfig | ContentComponent)[]): (StackConfig | ContentComponent)[] => {
        return elements.map((element) => {
          if (element.type === 'stack' && element.id === selectedId) {
            return {
              ...element,
              children: [...element.children, newContent],
            };
          }
          if (element.type === 'stack' && 'children' in element) {
            return {
              ...element,
              children: addToStack(element.children),
            };
          }
          if (element.id === selectedId && 'children' in element === false) {
            return element;
          }
          return element;
        });
      };

      let foundInStack = false;
      const findParentStack = (elements: (StackConfig | ContentComponent)[]): boolean => {
        for (const element of elements) {
          if (element.type === 'stack') {
            if (element.children.some((child) => child.id === selectedId)) {
              foundInStack = true;
              return true;
            }
            if (findParentStack(element.children)) return true;
          }
        }
        return false;
      };

      findParentStack(pageSection.stacks);

      if (foundInStack || pageSection.stacks.some((s) => s.id === selectedId)) {
        return {
          ...pageSection,
          stacks: addToStack(pageSection.stacks) as StackConfig[],
        };
      }

      const updatedGrids = pageSection.grids.map((grid) => {
        if (grid.id === selectedId || grid.children.some((c) => c.id === selectedId)) {
          return {
            ...grid,
            children: [...grid.children, newContent],
          };
        }
        return grid;
      });

      return { ...pageSection, grids: updatedGrids };
    });

    setSections(updatedSections);
    setIsLibraryOpen(false);
  };

  // ============================================================================
  // CRUD OPERATIONS - Delete
  // ============================================================================

  const handleDelete = (id: string) => {
    if (!confirm('Are you sure you want to delete this element?')) return;

    const filteredSections = sections.filter((ps) => ps.section.id !== id);
    if (filteredSections.length !== sections.length) {
      setSections(filteredSections);
      setSelectedId(null);
      return;
    }

    const updatedSections = sections.map((pageSection) => {
      const deleteFromElements = (elements: (StackConfig | ContentComponent)[]): (StackConfig | ContentComponent)[] => {
        return elements
          .filter((element) => element.id !== id)
          .map((element) => {
            if ('children' in element && Array.isArray(element.children)) {
              return {
                ...element,
                children: deleteFromElements(element.children),
              };
            }
            return element;
          });
      };

      const updatedStacks = deleteFromElements(pageSection.stacks) as StackConfig[];
      
      const filteredGrids = pageSection.grids.filter((g) => g.id !== id);
      const updatedGrids = filteredGrids.map((grid) => ({
        ...grid,
        children: grid.children.filter((c) => c.id !== id),
      }));

      return {
        ...pageSection,
        stacks: updatedStacks,
        grids: updatedGrids,
      };
    });

    setSections(updatedSections);
    setSelectedId(null);
  };

  // ============================================================================
  // CRUD OPERATIONS - Duplicate
  // ============================================================================

  const handleDuplicate = (id: string) => {
    for (let i = 0; i < sections.length; i++) {
      if (sections[i].section.id === id) {
        const duplicated = JSON.parse(JSON.stringify(sections[i]));
        
        const regenerateIds = (obj: any): any => {
          if (Array.isArray(obj)) {
            return obj.map(regenerateIds);
          }
          if (obj && typeof obj === 'object') {
            const newObj = { ...obj };
            if (newObj.id) {
              newObj.id = `${newObj.type}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            }
            Object.keys(newObj).forEach((key) => {
              newObj[key] = regenerateIds(newObj[key]);
            });
            return newObj;
          }
          return obj;
        };

        const regeneratedSection = regenerateIds(duplicated);
        const newSections = [...sections];
        newSections.splice(i + 1, 0, regeneratedSection);
        setSections(newSections);
        return;
      }
    }

    const updatedSections = sections.map((pageSection) => {
      const duplicateInElements = (
        elements: (StackConfig | ContentComponent)[]
      ): (StackConfig | ContentComponent)[] | null => {
        for (let i = 0; i < elements.length; i++) {
          if (elements[i].id === id) {
            const duplicated = JSON.parse(JSON.stringify(elements[i]));
            duplicated.id = `${duplicated.type}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            
            const newElements = [...elements];
            newElements.splice(i + 1, 0, duplicated);
            return newElements;
          }

          if (elements[i].type === 'stack' && 'children' in elements[i]) {
            const stackElement = elements[i] as StackConfig;
            const result = duplicateInElements(stackElement.children);
            if (result) {
              const newElements = [...elements];
              newElements[i] = {
                ...elements[i],
                children: result,
              } as StackConfig;
              return newElements;
            }
          }
        }
        return null;
      };

      const duplicatedStacks = duplicateInElements(pageSection.stacks);
      if (duplicatedStacks) {
        return {
          ...pageSection,
          stacks: duplicatedStacks as StackConfig[],
        };
      }

      for (let i = 0; i < pageSection.grids.length; i++) {
        if (pageSection.grids[i].id === id) {
          const duplicated = JSON.parse(JSON.stringify(pageSection.grids[i]));
          duplicated.id = `grid-${Date.now()}`;
          const newGrids = [...pageSection.grids];
          newGrids.splice(i + 1, 0, duplicated);
          return { ...pageSection, grids: newGrids };
        }

        const contentIndex = pageSection.grids[i].children.findIndex((c) => c.id === id);
        if (contentIndex !== -1) {
          const duplicated = { ...pageSection.grids[i].children[contentIndex] };
          duplicated.id = `${duplicated.type}-${Date.now()}`;
          const newChildren = [...pageSection.grids[i].children];
          newChildren.splice(contentIndex + 1, 0, duplicated);
          const newGrids = [...pageSection.grids];
          newGrids[i] = { ...newGrids[i], children: newChildren };
          return { ...pageSection, grids: newGrids };
        }
      }

      return pageSection;
    });

    setSections(updatedSections);
  };

  // ============================================================================
  // CRUD OPERATIONS - Move
  // ============================================================================

  const handleMove = (id: string, direction: 'up' | 'down') => {
    const move = direction === 'up' ? -1 : 1;

    for (let i = 0; i < sections.length; i++) {
      if (sections[i].section.id === id) {
        const newIndex = i + move;
        if (newIndex < 0 || newIndex >= sections.length) return;
        const newSections = [...sections];
        [newSections[i], newSections[newIndex]] = [newSections[newIndex], newSections[i]];
        setSections(newSections);
        return;
      }
    }

    const updatedSections = sections.map((pageSection) => {
      const moveInElements = (
        elements: (StackConfig | ContentComponent)[]
      ): (StackConfig | ContentComponent)[] | null => {
        const index = elements.findIndex((e) => e.id === id);
        if (index !== -1) {
          const newIndex = index + move;
          if (newIndex < 0 || newIndex >= elements.length) return elements;
          const newElements = [...elements];
          [newElements[index], newElements[newIndex]] = [newElements[newIndex], newElements[index]];
          return newElements;
        }

        for (let i = 0; i < elements.length; i++) {
          if (elements[i].type === 'stack' && 'children' in elements[i]) {
            const stackElement = elements[i] as StackConfig;
            const result = moveInElements(stackElement.children);
            if (result && result !== stackElement.children) {
              const newElements = [...elements];
              newElements[i] = {
                ...elements[i],
                children: result,
              } as StackConfig;
              return newElements;
            }
          }
        }
        return null;
      };

      const movedStacks = moveInElements(pageSection.stacks);
      if (movedStacks) {
        return {
          ...pageSection,
          stacks: movedStacks as StackConfig[],
        };
      }

      const gridIndex = pageSection.grids.findIndex((g) => g.id === id);
      if (gridIndex !== -1) {
        const newIndex = gridIndex + move;
        if (newIndex < 0 || newIndex >= pageSection.grids.length) return pageSection;
        const newGrids = [...pageSection.grids];
        [newGrids[gridIndex], newGrids[newIndex]] = [newGrids[newIndex], newGrids[gridIndex]];
        return { ...pageSection, grids: newGrids };
      }

      const updatedGrids = pageSection.grids.map((grid) => {
        const contentIndex = grid.children.findIndex((c) => c.id === id);
        if (contentIndex !== -1) {
          const newIndex = contentIndex + move;
          if (newIndex < 0 || newIndex >= grid.children.length) return grid;
          const newChildren = [...grid.children];
          [newChildren[contentIndex], newChildren[newIndex]] = [newChildren[newIndex], newChildren[contentIndex]];
          return { ...grid, children: newChildren };
        }
        return grid;
      });

      return { ...pageSection, grids: updatedGrids };
    });

    setSections(updatedSections);
  };

  // ============================================================================
  // CRUD OPERATIONS - Update
  // ============================================================================

  const handleUpdate = (updated: any) => {
    setSections((prev) =>
      prev.map((pageSection) => {
        if (pageSection.section.id === updated.id) {
          return { ...pageSection, section: updated };
        }
        if (pageSection.container.id === updated.id) {
          return { ...pageSection, container: updated };
        }

        const updateInElements = (
          elements: (StackConfig | ContentComponent)[]
        ): (StackConfig | ContentComponent)[] => {
          return elements.map((element) => {
            if (element.id === updated.id) return updated;
            if ('children' in element && Array.isArray(element.children)) {
              return {
                ...element,
                children: updateInElements(element.children),
              };
            }
            return element;
          });
        };

        const updatedStacks = updateInElements(pageSection.stacks) as StackConfig[];

        const updatedGrids = pageSection.grids.map((grid) => {
          if (grid.id === updated.id) {
            if (updated.type === 'grid' && updated.columns !== grid.columns) {
              const newChildren = Array.from({ length: updated.columns }, (_, i) => {
                return grid.children[i] || {
                  id: `text-${Date.now()}-${i}`,
                  type: 'text' as const,
                  text: `Grid Item ${i + 1}`,
                  fontSize: 16,
                  fontWeight: 400,
                  color: '#9ca3af',
                  textAlign: 'center' as const,
                } as TextConfig;
              });
              return { ...updated, children: newChildren };
            }
            return updated;
          }
          const updatedChildren = grid.children.map((content) =>
            content.id === updated.id ? updated : content
          );
          return { ...grid, children: updatedChildren };
        });

        return { ...pageSection, stacks: updatedStacks, grids: updatedGrids };
      })
    );
  };

  // ============================================================================
  // RENDERING HELPERS
  // ============================================================================

  const renderContent = (content: ContentComponent) => {
    const isSelected = selectedId === content.id;

    if (content.type === 'heading') {
      return <ContentHeading config={content} isSelected={isSelected} onSelect={setSelectedId} />;
    }
    if (content.type === 'text') {
      return <ContentText config={content} isSelected={isSelected} onSelect={setSelectedId} />;
    }
    if (content.type === 'button') {
      return <ContentButton config={content} isSelected={isSelected} onSelect={setSelectedId} />;
    }
    if (content.type === 'image') {
      return <ContentImage config={content} isSelected={isSelected} onSelect={setSelectedId} />;
    }
    return null;
  };

  const renderStackChildren = (children: (StackConfig | ContentComponent)[]) => {
    return children.map((child) => {
      if (child.type === 'stack') {
        return (
          <SelectableBlockWrapper
            key={child.id}
            element={child}
            selectedId={selectedId}
            onSelect={setSelectedId}
          >
            <Stack config={child}>
              {child.children.length === 0 ? (
                <div className="text-center py-6 text-gray-400 border-2 border-dashed border-purple-300 rounded-lg">
                  Empty nested stack - click "+ Add Content"
                </div>
              ) : (
                renderStackChildren(child.children)
              )}
            </Stack>
          </SelectableBlockWrapper>
        );
      }
      return <React.Fragment key={child.id}>{renderContent(child)}</React.Fragment>;
    });
  };

  const getSmartAddButtonText = () => {
    const selectedType = getSelectedElementType();
    if (!selectedType) return '+ Add Section';
    if (selectedType === 'section' || selectedType === 'container') return '+ Add Stack/Grid';
    if (selectedType === 'stack' || selectedType === 'grid' || selectedType === 'content') return '+ Add Content';
    return '+';
  };

  const formatLastSaved = () => {
    if (!lastSaved) return 'Never';
    const now = new Date();
    const diff = Math.floor((now.getTime() - lastSaved.getTime()) / 1000);
    
    if (diff < 60) return 'Just now';
    if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
    if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
    return lastSaved.toLocaleDateString();
  };

  // ============================================================================
  // MAIN RENDER
  // ============================================================================

  return (
    <div className="flex gap-4 h-full">
      <div className="flex-1 relative overflow-auto bg-gray-50 p-8">
        {/* Save Status Indicator */}
        <div className="fixed top-20 left-8 bg-white border border-gray-200 rounded-lg shadow-sm px-4 py-2 z-50 flex items-center gap-3">
          <div className="flex items-center gap-2">
            {saveStatus === 'saving' && (
              <>
                <div className="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
                <span className="text-sm text-gray-600">Saving...</span>
              </>
            )}
            {saveStatus === 'saved' && (
              <>
                <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                <span className="text-sm text-gray-600">Saved {formatLastSaved()}</span>
              </>
            )}
            {saveStatus === 'unsaved' && (
              <>
                <div className="w-2 h-2 bg-orange-500 rounded-full"></div>
                <span className="text-sm text-gray-600">Unsaved changes</span>
              </>
            )}
          </div>
          
          <div className="flex items-center gap-1 border-l border-gray-200 pl-3">
            <button
              onClick={handleManualSave}
              className="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded transition"
              title="Save Now (Ctrl+S)"
            >
              Save
            </button>
            <button
              onClick={handleExport}
              className="px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs rounded transition"
              title="Export as JSON"
            >
              Export
            </button>
            <label className="px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs rounded transition cursor-pointer">
              Import
              <input
                type="file"
                accept=".json"
                onChange={handleImport}
                className="hidden"
              />
            </label>
          </div>
        </div>

        {selectedId && (
          <div className="fixed top-20 right-96 bg-black text-white px-3 py-2 rounded-lg z-50 text-xs font-mono flex items-center gap-2 shadow-lg">
            <span className="opacity-70">Selected:</span>
            <span className="font-bold">{selectedId}</span>
            <div className="flex gap-1 ml-3 border-l border-gray-600 pl-3">
              <button
                onClick={() => handleMove(selectedId, 'up')}
                className="px-2 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs transition"
                title="Move Up"
              >
                ‚Üë
              </button>
              <button
                onClick={() => handleMove(selectedId, 'down')}
                className="px-2 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs transition"
                title="Move Down"
              >
                ‚Üì
              </button>
              <button
                onClick={() => handleDuplicate(selectedId)}
                className="px-2 py-1 bg-blue-600 hover:bg-blue-500 rounded text-xs transition"
                title="Duplicate"
              >
                ‚éò
              </button>
              <button
                onClick={() => handleDelete(selectedId)}
                className="px-2 py-1 bg-red-600 hover:bg-red-500 rounded text-xs transition"
                title="Delete"
              >
                ‚úï
              </button>
            </div>
          </div>
        )}

        <button
          onClick={handleSmartAdd}
          className="fixed bottom-8 right-96 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-xl flex items-center justify-center text-sm font-semibold z-40 px-6 py-3 transition-all hover:scale-105"
          title={getSmartAddButtonText()}
        >
          {getSmartAddButtonText()}
        </button>

        <div className="space-y-8 mt-16">
          {sections.map((pageSection) => (
            <div key={pageSection.section.id} className="relative group">
              <SelectableBlockWrapper
                element={pageSection.section}
                selectedId={selectedId}
                onSelect={setSelectedId}
              >
                <Section config={pageSection.section}>
                  <SelectableBlockWrapper
                    element={pageSection.container}
                    selectedId={selectedId}
                    onSelect={setSelectedId}
                  >
                    <Container config={pageSection.container}>
                      <div className="space-y-4">
                        {pageSection.stacks.map((stack) => (
                          <SelectableBlockWrapper
                            key={stack.id}
                            element={stack}
                            selectedId={selectedId}
                            onSelect={setSelectedId}
                          >
                            <Stack config={stack}>
                              {stack.children.length === 0 ? (
                                <div className="text-center py-8 text-gray-400 border-2 border-dashed border-gray-300 rounded-lg">
                                  Empty stack - click "+ Add Content" to add elements
                                </div>
                              ) : (
                                renderStackChildren(stack.children)
                              )}
                            </Stack>
                          </SelectableBlockWrapper>
                        ))}

                        {pageSection.grids.map((grid) => (
                          <SelectableBlockWrapper
                            key={grid.id}
                            element={grid}
                            selectedId={selectedId}
                            onSelect={setSelectedId}
                          >
                            <Grid config={grid}>
                              {grid.children.length === 0 ? (
                                <div className="text-center py-8 text-gray-400 border-2 border-dashed border-orange-300 rounded-lg col-span-full">
                                  Empty grid - click "+ Add Content" to add elements
                                </div>
                              ) : (
                                grid.children.map((content) => (
                                  <React.Fragment key={content.id}>{renderContent(content)}</React.Fragment>
                                ))
                              )}
                            </Grid>
                          </SelectableBlockWrapper>
                        ))}
                      </div>
                    </Container>
                  </SelectableBlockWrapper>
                </Section>
              </SelectableBlockWrapper>
            </div>
          ))}
        </div>

        {sections.length === 0 && (
          <div className="text-center py-20 text-gray-400 mt-16">
            <p className="text-xl mb-4">No sections yet</p>
            <button
              onClick={handleSmartAdd}
              className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg"
            >
              + Add First Section
            </button>
          </div>
        )}
      </div>

      <div className="w-80 bg-white border-l border-gray-200 overflow-auto shadow-lg">
        <PrimitivePropertiesPanel selectedElement={getSelectedElement()} onUpdate={handleUpdate} />
      </div>

      <ComponentLibrary
        isOpen={isLibraryOpen}
        onClose={() => setIsLibraryOpen(false)}
        onAddSection={handleAddSection}
        onAddStack={handleAddStack}
        onAddGrid={handleAddGrid}
        onAddContent={handleAddContent}
      />
    </div>
  );
}