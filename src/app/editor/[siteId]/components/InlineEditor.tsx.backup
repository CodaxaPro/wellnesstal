'use client';

import { useEffect, useState, useRef } from 'react';
import { useEditor, EditorContent } from '@tiptap/react';
import StarterKit from '@tiptap/starter-kit';
import Underline from '@tiptap/extension-underline';
import { TextStyle } from '@tiptap/extension-text-style';
import { Color } from '@tiptap/extension-color';
import { Highlight } from '@tiptap/extension-highlight';
import TextAlign from '@tiptap/extension-text-align';
import Link from '@tiptap/extension-link';
import Typography from '@tiptap/extension-typography';
import { useContentStore } from '../store/useContentStore';

export default function InlineEditor() {
  const { activeField, content, updateContent, setActiveField } = useContentStore();
  const [position, setPosition] = useState({ top: 0, left: 0 });
  const [isDragging, setIsDragging] = useState(false);
  const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
  const [showColorPicker, setShowColorPicker] = useState(false);
  const [showHighlightPicker, setShowHighlightPicker] = useState(false);
  const popupRef = useRef<HTMLDivElement>(null);

  // Field type detection
  const getFieldType = (path: string): 'title' | 'button' | 'contact' | 'normal' => {
    if (path.includes('cta') || path.includes('button')) return 'button';
    if (path.includes('phone') || path.includes('email')) return 'contact';
    if (path.includes('title')) return 'title';
    return 'normal';
  };

  const fieldType = activeField ? getFieldType(activeField) : 'normal';
  const showHeadings = fieldType !== 'button' && fieldType !== 'contact';

  const editor = useEditor({
    immediatelyRender: false,
    extensions: [
      StarterKit.configure({
        heading: showHeadings ? { levels: [1, 2, 3] } : false,
      }),
      Underline,
      TextStyle,
      Color,
      Highlight.configure({ multicolor: true }),
      TextAlign.configure({
        types: ['heading', 'paragraph'],
      }),
      Link.configure({
        openOnClick: false,
        HTMLAttributes: {
          class: 'text-purple-600 underline hover:text-purple-700',
        },
      }),
      Typography,
    ],
    content: '',
    editorProps: {
      attributes: {
        class: 'prose prose-sm sm:prose lg:prose-lg xl:prose-xl focus:outline-none min-h-[200px] max-h-[400px] overflow-y-auto px-4 py-3',
      },
    },
  });

  const updatePosition = () => {
    if (!activeField) return;
    
    const overlay = document.querySelector(`[data-path="${activeField}"]`);
    if (overlay) {
      const rect = overlay.getBoundingClientRect();
      const popupWidth = 700;
      const popupLeft = Math.max(20, Math.min(
        rect.left + (rect.width / 2) - (popupWidth / 2),
        window.innerWidth - popupWidth - 20
      ));
      
      let popupTop = rect.bottom + 10;
      const popupHeight = 500;
      
      if (popupTop + popupHeight > window.innerHeight) {
        popupTop = rect.top - popupHeight - 10;
      }
      
      setPosition({
        top: Math.max(10, popupTop),
        left: popupLeft,
      });
    }
  };

  useEffect(() => {
    if (activeField && editor) {
      let currentValue = '';
      const keys = activeField.split('.');
      
      if (keys[0] === 'businessName') {
        currentValue = content.businessName || '';
      } else {
        const [sectionType, fieldName] = keys;
        const section = content.sections.find(s => s.type === sectionType);
        if (section) {
          currentValue = section.content[fieldName] || '';
        }
      }
      
      editor.commands.setContent(currentValue);
      setTimeout(updatePosition, 50);

      window.addEventListener('scroll', updatePosition, true);
      window.addEventListener('resize', updatePosition);

      return () => {
        window.removeEventListener('scroll', updatePosition, true);
        window.removeEventListener('resize', updatePosition);
      };
    }
  }, [activeField, content, editor]);

  const handleMouseDown = (e: React.MouseEvent) => {
    if (e.target === e.currentTarget || (e.target as HTMLElement).closest('.drag-handle')) {
      setIsDragging(true);
      setDragOffset({
        x: e.clientX - position.left,
        y: e.clientY - position.top,
      });
    }
  };

  useEffect(() => {
    const handleMouseMove = (e: MouseEvent) => {
      if (isDragging) {
        setPosition({
          top: Math.max(0, Math.min(e.clientY - dragOffset.y, window.innerHeight - 100)),
          left: Math.max(0, Math.min(e.clientX - dragOffset.x, window.innerWidth - 700)),
        });
      }
    };

    const handleMouseUp = () => {
      setIsDragging(false);
    };

    if (isDragging) {
      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseup', handleMouseUp);
    }

    return () => {
      document.removeEventListener('mousemove', handleMouseMove);
      document.removeEventListener('mouseup', handleMouseUp);
    };
  }, [isDragging, dragOffset]);

  const handleSave = () => {
    if (activeField && editor) {
      const htmlContent = editor.getHTML();
      updateContent(activeField, htmlContent);
      setActiveField(null);
    }
  };

  const handleCancel = () => {
    setActiveField(null);
  };

  const colors = [
    '#000000', '#374151', '#6B7280', '#9CA3AF', '#D1D5DB',
    '#EF4444', '#F97316', '#F59E0B', '#EAB308', '#84CC16',
    '#22C55E', '#10B981', '#14B8A6', '#06B6D4', '#0EA5E9',
    '#3B82F6', '#6366F1', '#8B5CF6', '#A855F7', '#D946EF',
    '#EC4899', '#F43F5E', '#FFFFFF',
  ];

  const highlights = [
    '#FEF3C7', '#FED7AA', '#FECACA', '#FBE2E3', '#FCE7F3',
    '#F3E8FF', '#E0E7FF', '#DBEAFE', '#CFFAFE', '#CCFBF1',
    '#D1FAE5', '#D9F99D', '#FEF9C3',
  ];

  if (!activeField || !editor) return null;

  const wordCount = editor.getText().trim().split(/\s+/).filter(Boolean).length;
  const charCount = editor.getText().length;

  return (
    <>
      {/* Premium Backdrop */}
      <div
        className="fixed inset-0 bg-gradient-to-br from-purple-900/30 via-black/40 to-indigo-900/30 backdrop-blur-sm z-[998] animate-in fade-in duration-300"
        onClick={handleCancel}
      />

      {/* Premium Popup */}
      <div
        ref={popupRef}
        className="fixed bg-white rounded-2xl shadow-2xl z-[999] border border-purple-200/50 animate-in zoom-in-95 duration-200"
        style={{
          top: `${position.top}px`,
          left: `${position.left}px`,
          width: '700px',
          cursor: isDragging ? 'grabbing' : 'default',
          boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(147, 51, 234, 0.1)',
        }}
      >
        {/* Header */}
        <div
          className="drag-handle bg-gradient-to-r from-purple-600 via-purple-500 to-indigo-600 text-white px-6 py-4 rounded-t-2xl flex justify-between items-center cursor-grab active:cursor-grabbing select-none"
          onMouseDown={handleMouseDown}
        >
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm">
              <span className="text-xl">‚ú®</span>
            </div>
            <div>
              <div className="font-semibold text-sm tracking-wide">Content Editor Pro</div>
              <div className="text-xs opacity-90 font-mono">{activeField}</div>
            </div>
          </div>
          <button
            onClick={handleCancel}
            className="text-white/70 hover:text-white hover:bg-white/20 w-9 h-9 rounded-lg flex items-center justify-center transition-all duration-200 text-xl"
          >
            √ó
          </button>
        </div>

        {/* Field Type Warning */}
        {(fieldType === 'button' || fieldType === 'contact') && (
          <div className="px-5 py-2 bg-amber-50 border-b border-amber-100">
            <p className="text-xs text-amber-700 flex items-center gap-2">
              <span>‚ö†Ô∏è</span>
              <span>Bu alan i√ßin ba≈ülƒ±k stilleri (H1, H2, H3) kullanƒ±lamaz.</span>
            </p>
          </div>
        )}

        {/* Toolbar */}
        <div className="px-5 py-3 bg-gradient-to-b from-gray-50 to-white border-b border-gray-100">
          <div className="flex flex-wrap items-center gap-2">
            {/* Text Style */}
            <div className="flex items-center gap-1 bg-white rounded-lg p-1 shadow-sm border border-gray-200">
              <button
                onClick={() => editor.chain().focus().toggleBold().run()}
                className={`px-2.5 py-1.5 rounded-md font-bold text-sm transition-all duration-200 ${
                  editor.isActive('bold') 
                    ? 'bg-purple-100 text-purple-700 shadow-sm' 
                    : 'text-gray-600 hover:bg-gray-100'
                }`}
                title="Bold (Cmd+B)"
              >
                B
              </button>
              <button
                onClick={() => editor.chain().focus().toggleItalic().run()}
                className={`px-2.5 py-1.5 rounded-md italic text-sm transition-all duration-200 ${
                  editor.isActive('italic') 
                    ? 'bg-purple-100 text-purple-700 shadow-sm' 
                    : 'text-gray-600 hover:bg-gray-100'
                }`}
                title="Italic (Cmd+I)"
              >
                I
              </button>
              <button
                onClick={() => editor.chain().focus().toggleUnderline().run()}
                className={`px-2.5 py-1.5 rounded-md underline text-sm transition-all duration-200 ${
                  editor.isActive('underline') 
                    ? 'bg-purple-100 text-purple-700 shadow-sm' 
                    : 'text-gray-600 hover:bg-gray-100'
                }`}
                title="Underline (Cmd+U)"
              >
                U
              </button>
              <button
                onClick={() => editor.chain().focus().toggleStrike().run()}
                className={`px-2.5 py-1.5 rounded-md line-through text-sm transition-all duration-200 ${
                  editor.isActive('strike') 
                    ? 'bg-purple-100 text-purple-700 shadow-sm' 
                    : 'text-gray-600 hover:bg-gray-100'
                }`}
                title="Strikethrough"
              >
                S
              </button>
            </div>

            {showHeadings && (
              <>
                <div className="w-px h-6 bg-gray-300" />

                {/* Headings */}
                <div className="flex items-center gap-1 bg-white rounded-lg p-1 shadow-sm border border-gray-200">
                  <button
                    onClick={() => editor.chain().focus().toggleHeading({ level: 1 }).run()}
                    className={`px-2.5 py-1.5 rounded-md text-sm font-semibold transition-all duration-200 ${
                      editor.isActive('heading', { level: 1 }) 
                        ? 'bg-purple-100 text-purple-700 shadow-sm' 
                        : 'text-gray-600 hover:bg-gray-100'
                    }`}
                  >
                    H1
                  </button>
                  <button
                    onClick={() => editor.chain().focus().toggleHeading({ level: 2 }).run()}
                    className={`px-2.5 py-1.5 rounded-md text-sm font-semibold transition-all duration-200 ${
                      editor.isActive('heading', { level: 2 }) 
                        ? 'bg-purple-100 text-purple-700 shadow-sm' 
                        : 'text-gray-600 hover:bg-gray-100'
                    }`}
                  >
                    H2
                  </button>
                  <button
                    onClick={() => editor.chain().focus().toggleHeading({ level: 3 }).run()}
                    className={`px-2.5 py-1.5 rounded-md text-sm font-semibold transition-all duration-200 ${
                      editor.isActive('heading', { level: 3 }) 
                        ? 'bg-purple-100 text-purple-700 shadow-sm' 
                        : 'text-gray-600 hover:bg-gray-100'
                    }`}
                  >
                    H3
                  </button>
                </div>
              </>
            )}

            <div className="w-px h-6 bg-gray-300" />

            {/* Colors */}
            <div className="relative">
              <button
                onClick={() => {
                  setShowColorPicker(!showColorPicker);
                  setShowHighlightPicker(false);
                }}
                className="px-3 py-1.5 bg-white rounded-lg shadow-sm border border-gray-200 hover:bg-gray-50 transition-all duration-200 text-sm flex items-center gap-2"
                title="Text Color"
              >
                <span className="text-lg">üé®</span>
                <span className="text-xs text-gray-600">Color</span>
              </button>
              
              {showColorPicker && (
                <div className="absolute top-12 left-0 bg-white rounded-xl shadow-2xl border border-gray-200 p-3 z-[1000] animate-in fade-in zoom-in-95 duration-200">
                  <div className="text-xs font-semibold text-gray-700 mb-2">Text Color</div>
                  <div className="grid grid-cols-7 gap-1.5 w-[180px]">
                    {colors.map(color => (
                      <button
                        key={color}
                        onClick={() => {
                          editor.chain().focus().setColor(color).run();
                          setShowColorPicker(false);
                        }}
                        className="w-6 h-6 rounded-md border-2 border-gray-200 hover:scale-110 transition-transform duration-200"
                        style={{ backgroundColor: color }}
                        title={color}
                      />
                    ))}
                  </div>
                </div>
              )}
            </div>

            <div className="relative">
              <button
                onClick={() => {
                  setShowHighlightPicker(!showHighlightPicker);
                  setShowColorPicker(false);
                }}
                className="px-3 py-1.5 bg-white rounded-lg shadow-sm border border-gray-200 hover:bg-gray-50 transition-all duration-200 text-sm flex items-center gap-2"
                title="Highlight"
              >
                <span className="text-lg">üñçÔ∏è</span>
                <span className="text-xs text-gray-600">Highlight</span>
              </button>
              
              {showHighlightPicker && (
                <div className="absolute top-12 left-0 bg-white rounded-xl shadow-2xl border border-gray-200 p-3 z-[1000] animate-in fade-in zoom-in-95 duration-200">
                  <div className="text-xs font-semibold text-gray-700 mb-2">Highlight Color</div>
                  <div className="grid grid-cols-5 gap-1.5 w-[140px]">
                    {highlights.map(color => (
                      <button
                        key={color}
                        onClick={() => {
                          editor.chain().focus().toggleHighlight({ color }).run();
                          setShowHighlightPicker(false);
                        }}
                        className="w-6 h-6 rounded-md border-2 border-gray-200 hover:scale-110 transition-transform duration-200"
                        style={{ backgroundColor: color }}
                        title={color}
                      />
                    ))}
                  </div>
                </div>
              )}
            </div>

            <div className="w-px h-6 bg-gray-300" />

            {/* Alignment */}
            <div className="flex items-center gap-1 bg-white rounded-lg p-1 shadow-sm border border-gray-200">
              <button
                onClick={() => editor.chain().focus().setTextAlign('left').run()}
                className={`px-2.5 py-1.5 rounded-md text-sm transition-all duration-200 ${
                  editor.isActive({ textAlign: 'left' }) 
                    ? 'bg-purple-100 text-purple-700' 
                    : 'text-gray-600 hover:bg-gray-100'
                }`}
                title="Align Left"
              >
                ‚¨ÖÔ∏è
              </button>
              <button
                onClick={() => editor.chain().focus().setTextAlign('center').run()}
                className={`px-2.5 py-1.5 rounded-md text-sm transition-all duration-200 ${
                  editor.isActive({ textAlign: 'center' }) 
                    ? 'bg-purple-100 text-purple-700' 
                    : 'text-gray-600 hover:bg-gray-100'
                }`}
                title="Align Center"
              >
                ‚¨ÜÔ∏è
              </button>
              <button
                onClick={() => editor.chain().focus().setTextAlign('right').run()}
                className={`px-2.5 py-1.5 rounded-md text-sm transition-all duration-200 ${
                  editor.isActive({ textAlign: 'right' }) 
                    ? 'bg-purple-100 text-purple-700' 
                    : 'text-gray-600 hover:bg-gray-100'
                }`}
                title="Align Right"
              >
                ‚û°Ô∏è
              </button>
            </div>

            <div className="w-px h-6 bg-gray-300" />

            {/* Lists */}
            <div className="flex items-center gap-1 bg-white rounded-lg p-1 shadow-sm border border-gray-200">
              <button
                onClick={() => editor.chain().focus().toggleBulletList().run()}
                className={`px-2.5 py-1.5 rounded-md text-sm transition-all duration-200 ${
                  editor.isActive('bulletList') 
                    ? 'bg-purple-100 text-purple-700' 
                    : 'text-gray-600 hover:bg-gray-100'
                }`}
                title="Bullet List"
              >
                ‚ö´
              </button>
              <button
                onClick={() => editor.chain().focus().toggleOrderedList().run()}
                className={`px-2.5 py-1.5 rounded-md text-sm transition-all duration-200 ${
                  editor.isActive('orderedList') 
                    ? 'bg-purple-100 text-purple-700' 
                    : 'text-gray-600 hover:bg-gray-100'
                }`}
                title="Numbered List"
              >
                üî¢
              </button>
            </div>

            <div className="flex-1" />

            {/* Undo/Redo */}
            <div className="flex items-center gap-1 bg-white rounded-lg p-1 shadow-sm border border-gray-200">
              <button
                onClick={() => editor.chain().focus().undo().run()}
                disabled={!editor.can().undo()}
                className="px-2.5 py-1.5 rounded-md text-sm text-gray-600 hover:bg-gray-100 transition-all duration-200 disabled:opacity-30"
                title="Undo (Cmd+Z)"
              >
                ‚Ü∂
              </button>
              <button
                onClick={() => editor.chain().focus().redo().run()}
                disabled={!editor.can().redo()}
                className="px-2.5 py-1.5 rounded-md text-sm text-gray-600 hover:bg-gray-100 transition-all duration-200 disabled:opacity-30"
                title="Redo (Cmd+Shift+Z)"
              >
                ‚Ü∑
              </button>
            </div>
          </div>
        </div>

        {/* Editor Content */}
        <div className="p-5 bg-gradient-to-b from-white to-gray-50">
          <div className="bg-white border-2 border-gray-200 rounded-xl focus-within:border-purple-400 focus-within:ring-4 focus-within:ring-purple-100 transition-all duration-200">
            <EditorContent editor={editor} />
          </div>

          {/* Stats */}
          <div className="mt-4 flex items-center justify-between text-xs">
            <div className="flex items-center gap-3 text-gray-500">
              <span className="flex items-center gap-1.5 bg-white px-3 py-1.5 rounded-lg border border-gray-200 shadow-sm">
                <span className="w-1.5 h-1.5 bg-purple-500 rounded-full animate-pulse" />
                <strong className="text-gray-700">{charCount}</strong> characters
              </span>
              <span className="flex items-center gap-1.5 bg-white px-3 py-1.5 rounded-lg border border-gray-200 shadow-sm">
                <strong className="text-gray-700">{wordCount}</strong> words
              </span>
            </div>
            
            <div className="text-gray-400 flex items-center gap-2">
              <span className="text-xs">üí° Use keyboard shortcuts</span>
            </div>
          </div>
        </div>

        {/* Actions */}
        <div className="flex gap-3 px-5 pb-5">
          <button
            onClick={handleCancel}
            className="flex-1 px-5 py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 hover:border-gray-300 font-semibold transition-all duration-200 hover:shadow-md"
          >
            Cancel
          </button>
          <button
            onClick={handleSave}
            className="flex-1 px-5 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-xl hover:from-purple-700 hover:to-indigo-700 font-semibold transition-all duration-200 shadow-lg shadow-purple-500/30 hover:shadow-xl hover:shadow-purple-500/40 hover:scale-[1.02]"
          >
            <span className="flex items-center justify-center gap-2">
              <span>‚úì</span>
              <span>Save Changes</span>
            </span>
          </button>
        </div>
      </div>
    </>
  );
}